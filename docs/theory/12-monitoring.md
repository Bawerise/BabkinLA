# Мониторинг PostgreSQL

## 1. Зачем нужен мониторинг

**Мониторинг** — это наблюдение за состоянием и поведением системы в реальном времени, чтобы:

* вовремя замечать проблемы;
* анализировать производительность;
* выявлять узкие места и отклонения от нормы;
* прогнозировать необходимость обслуживания и оптимизации.

Для PostgreSQL мониторинг можно разделить на два уровня:

1. **Мониторинг со стороны операционной системы** — использование системных инструментов для контроля процессов, памяти, процессора и дисков.
2. **Мониторинг со стороны PostgreSQL** — использование встроенных средств статистики и журнала сообщений.

---

## 2. Мониторинг средствами операционной системы

PostgreSQL работает поверх ОС, и его производительность напрямую зависит от состояния системы.
Для наблюдения за ней можно использовать стандартные утилиты Unix-подобных систем.

### Основные направления мониторинга

| Задача                            | Инструменты            |
| --------------------------------- | ---------------------- |
| Просмотр процессов PostgreSQL     | `ps`, `pgrep`          |
| Использование процессора и памяти | `top`, `vmstat`, `sar` |
| Работа дисковой подсистемы        | `iostat`               |
| Контроль свободного места         | `df`, `du`, `quota`    |

### Полезные параметры PostgreSQL

* **`update_process_title`** — если включён (по умолчанию), в названии процесса отображается его текущее состояние (например, выполняемая команда).
* **`cluster_name`** — позволяет задать имя кластера, чтобы различать несколько экземпляров PostgreSQL.

---

## 3. Накопительная статистика PostgreSQL

Встроенная **система накопительной статистики** собирает сведения о работе сервера: активности, обращениях к таблицам и индексам, времени выполнения операций и т. д.

### Основные параметры

| Параметр              | Что делает                                                                              |
| --------------------- | --------------------------------------------------------------------------------------- |
| `track_activities`    | Ведёт учёт текущих выполняемых команд.                                                  |
| `track_counts`        | Считает обращения к таблицам и индексам.                                                |
| `track_functions`     | Отслеживает вызовы пользовательских функций и время выполнения (по умолчанию выключен). |
| `track_io_timing`     | Измеряет время чтения и записи данных (по умолчанию выключен).                          |
| `track_wal_io_timing` | Измеряет время записи в журнал WAL (по умолчанию выключен).                             |

> Чем больше собирается данных, тем выше накладные расходы. Поэтому включают только действительно необходимые параметры.

---

## 4. Архитектура сбора статистики

Сведения собираются фоновыми процессами и:

1. временно хранятся в **разделяемой памяти**;
2. периодически сбрасываются в файлы `PGDATA/pg_stat/`;
3. при штатном завершении работы сервера сохраняются, а при аварийной — сбрасываются.

### Кэширование статистики

Поведение регулирует параметр **`stats_fetch_consistency`**:

| Значение                 | Поведение                                                                   |
| ------------------------ | --------------------------------------------------------------------------- |
| `none`                   | Всегда берутся свежие данные из памяти.                                     |
| `cache` *(по умолчанию)* | Статистика кэшируется по объектам — компромисс между скоростью и точностью. |
| `snapshot`               | Вся статистика базы кэшируется целиком до конца транзакции.                 |

---

## 5. Просмотр накопительной статистики

PostgreSQL предоставляет множество представлений `pg_stat_*`:

| Представление                                  | Назначение                                           |
| ---------------------------------------------- | ---------------------------------------------------- |
| `pg_stat_all_tables`                           | Статистика обращений к таблицам.                     |
| `pg_statio_all_tables`                         | Ввод-вывод по таблицам.                              |
| `pg_stat_all_indexes`, `pg_statio_all_indexes` | Статистика по индексам.                              |
| `pg_stat_database`                             | Общая статистика по базе данных.                     |
| `pg_stat_io`                                   | Сведения о чтении/записи страниц по типам процессов. |

Эти данные помогают:

* определить, какие таблицы или индексы активно используются;
* найти неиспользуемые индексы;
* оценить эффективность буферного кеша (`hits` против `reads`);
* увидеть количество коммитов, роллбеков, взаимоблокировок, использование временных файлов и др.

---

## 6. Текущие активности (`pg_stat_activity`)

Представление `pg_stat_activity` показывает все активные процессы сервера — как клиентские, так и фоновые.

Каждая строка содержит:

* `pid` — идентификатор процесса;
* `query` — выполняемую команду;
* `state` — состояние (например, `active`, `idle`, `idle in transaction`);
* `wait_event` и `wait_event_type` — события ожидания (например, блокировки);
* `backend_type` — тип процесса (клиент, автovacuum, checkpointer и т. д.).

### Особенности

* Параметр **`track_activities`** должен быть включён (по умолчанию он включён).
* Состояние `idle in transaction` означает, что клиент держит незавершённую транзакцию — это может мешать очистке старых версий данных.

Для автоматического завершения таких сеансов можно использовать:

* `idle_in_transaction_session_timeout` — завершает «зависшие» транзакции;
* `idle_session_timeout` — завершает полностью бездействующие сеансы.

Также для диагностики блокировок доступны:

* `pg_blocking_pids(pid)` — возвращает список процессов, блокирующих данный;
* `pg_locks` — показывает активные блокировки в системе.

---

## 7. Отслеживание выполнения команд

Некоторые длительные операции (индексация, очистка, анализ и т. д.) можно контролировать по ходу выполнения.

| Команда                   | Представление                   |
| ------------------------- | ------------------------------- |
| `VACUUM`                  | `pg_stat_progress_vacuum`       |
| `ANALYZE`                 | `pg_stat_progress_analyze`      |
| `CREATE INDEX`, `REINDEX` | `pg_stat_progress_create_index` |
| `CLUSTER`, `VACUUM FULL`  | `pg_stat_progress_cluster`      |
| `COPY`                    | `pg_stat_progress_copy`         |
| Резервное копирование     | `pg_stat_progress_basebackup`   |

Эти представления позволяют видеть, какой процент работы выполнен, сколько страниц обработано и т. д.

---

## 8. Дополнительная статистика: расширения

PostgreSQL поддерживает модули, расширяющие возможности мониторинга.

| Расширение               | Что делает                                                                                         |
| ------------------------ | -------------------------------------------------------------------------------------------------- |
| **`pg_stat_statements`** | Сохраняет статистику по запросам: количество вызовов, среднее время выполнения, отклонения и т. д. |
| **`pg_buffercache`**     | Позволяет заглянуть в содержимое буферного кеша.                                                   |
| **`pgstattuple`**        | Показывает количество «мертвых» строк и оценку степени фрагментации таблицы.                       |
| **`pg_wait_sampling`**   | Сбор статистики ожиданий.                                                                          |
| **`pg_stat_kcache`**     | Показывает статистику по использованию CPU и дисков.                                               |
| **`pg_qualstats`**       | Считает частоту использования предикатов (WHERE-условий).                                          |

> Большинство этих расширений устанавливаются через `CREATE EXTENSION` и требуют загрузки модуля в `shared_preload_libraries`.

---

## 9. Журнал сообщений сервера (PostgreSQL logs)

Журнал сообщений — второй основной источник информации о работе сервера.

### Основные параметры

| Параметр                        | Назначение                                                                      |
| ------------------------------- | ------------------------------------------------------------------------------- |
| `log_destination`               | Задаёт приёмники и формат: `stderr`, `csvlog`, `jsonlog`, `syslog`, `eventlog`. |
| `logging_collector`             | Включает коллектор сообщений — процесс, записывающий логи в файлы.              |
| `log_directory`, `log_filename` | Каталог и имя файла журнала.                                                    |

При использовании коллектора можно включить вывод в форматах:

* **CSV** (`csvlog`) — удобно для импорта в системы анализа;
* **JSON** (`jsonlog`) — удобно для машинной обработки.

---

## 10. Содержание журнала

Можно управлять тем, какие события и в каком объёме записываются.

| Настраиваемая информация          | Параметр                                     |
| --------------------------------- | -------------------------------------------- |
| Минимальный уровень сообщений     | `log_min_messages`                           |
| Время выполнения команд           | `log_duration`, `log_min_duration_statement` |
| Подключения и отключения клиентов | `log_connections`, `log_disconnections`      |
| Контрольные точки                 | `log_checkpoints`                            |
| Долгие ожидания блокировок        | `log_lock_waits`                             |
| Использование временных файлов    | `log_temp_files`                             |
| Исполняемые SQL-команды           | `log_statement`                              |

> По умолчанию большинство этих параметров отключено — чтобы не перегружать систему избыточным логированием.

---

## 11. Ротация журналов

Если логи писать в один файл, он быстро вырастет до больших размеров.
Поэтому PostgreSQL поддерживает **ротацию журналов** — автоматическое переключение на новый файл.

### Основные параметры

| Параметр                   | Назначение                                         |
| -------------------------- | -------------------------------------------------- |
| `log_filename`             | Маска имени файла (например, `postgresql-%H.log`). |
| `log_rotation_age`         | Через сколько минут создавать новый файл.          |
| `log_rotation_size`        | Максимальный размер файла до ротации.              |
| `log_truncate_on_rotation` | Перезаписывать существующий файл при ротации.      |

Пример схем:

* `'postgresql-%H.log'`, `1h` → создаётся 24 файла в сутки;
* `'postgresql-%a.log'`, `1d` → по одному файлу на день недели.

Во многих дистрибутивах также используется внешняя утилита **`logrotate`**.

---

## 12. Анализ журналов

Для анализа журналов можно использовать:

* стандартные средства (`grep`, `awk`, `less`);
* специализированные утилиты.

Наиболее распространённый инструмент — **PgBadger**
([https://github.com/darold/pgbadger](https://github.com/darold/pgbadger)), который визуализирует статистику запросов, ошибок и медленных операций.
Важно: он требует журналов на английском языке и определённого формата сообщений.

---

## 13. Внешние системы мониторинга

Встроенные средства PostgreSQL не обеспечивают полноценного мониторинга с историей, графиками и уведомлениями.
Для этого используются внешние системы.

### Универсальные системы

* **Zabbix**, **Munin**, **Cacti**;
* облачные решения: **Okmeter**, **NewRelic**, **Datadog** и др.

### Специализированные системы для PostgreSQL

* **PGObserver**
* **PoWA** (*PostgreSQL Workload Analyzer*)
* **OPM** (*Open PostgreSQL Monitoring*)
* **pg_profile** — собирает снимки статистики и позволяет анализировать динамику;
* **pgpro_pwr** — расширенная коммерческая версия `pg_profile`.

Полезные ссылки:

* [Список систем мониторинга на wiki.postgresql.org](https://wiki.postgresql.org/wiki/Monitoring)
* [pgpro_pwr — документация](https://postgrespro.ru/docs/enterprise/16/pgpro-pwr)
* [Книга А. Лесовского «Мониторинг PostgreSQL»](https://edu.postgrespro.ru/monitoring.pdf)

---

## 14. Итоги

* Мониторинг PostgreSQL должен вестись **на двух уровнях** — со стороны ОС и со стороны сервера.
* PostgreSQL предоставляет:

  * накопительную статистику (`pg_stat_*`);
  * журнал сообщений сервера;
  * расширения для анализа производительности.
* Для комплексного контроля и визуализации данных используются **внешние системы мониторинга**.
