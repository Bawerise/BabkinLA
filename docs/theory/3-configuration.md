# Конфигурирование сервера PostgreSQL

## 1. Что такое параметры конфигурации

PostgreSQL — гибко настраиваемая система.
Её работа определяется **параметрами конфигурации**, которые задают:

* количество одновременно подключённых клиентов;
* объёмы используемой памяти;
* поведение журналирования;
* сетевые настройки;
* и множество других аспектов.

Изменяя эти параметры, администратор управляет производительностью, надёжностью и безопасностью системы.

### Где задаются параметры

Параметры можно установить:

1. **Для всего экземпляра сервера** — в конфигурационных файлах;
2. **Для отдельной базы данных или пользователя** — через SQL;
3. **Для текущего сеанса** — командой `SET` или функцией `set_config()`.

Чем "ближе" уровень к пользователю, тем он приоритетнее.
Например, значение, заданное в сеансе, перекрывает настройки файлов конфигурации.

Полный список параметров и их описание приведён в официальной документации:
[postgrespro.ru/docs/postgresql/16/runtime-config](https://postgrespro.ru/docs/postgresql/16/runtime-config)

---

## 2. Основной конфигурационный файл `postgresql.conf`

### Назначение

Это **главный файл настроек** PostgreSQL.
Он считывается при запуске сервера и задаёт параметры работы всей СУБД.

### Расположение

По умолчанию `postgresql.conf` находится в каталоге с данными (`PGDATA`).
Однако в дистрибутивах Linux, например Ubuntu, этот файл часто размещён отдельно — обычно в `/etc/postgresql/версия/main/`.

Точное местоположение можно узнать:

```sql
SHOW config_file;
```

### Формат

Файл — это обычный текст в виде пар `параметр = значение`.
Комментарии начинаются с `#`.
Параметры можно организовывать в логические разделы.

Пример:

```conf
data_directory = '/var/lib/postgresql/16/main'    # каталог данных
hba_file       = '/etc/postgresql/16/main/pg_hba.conf'
port           = 5432
max_connections = 100
```

### Вступление изменений в силу

После правок PostgreSQL должен перечитать файл:

```bash
pg_ctl reload
# или
SELECT pg_reload_conf();
```

Если параметр влияет на стартовую инициализацию серверных процессов (например, `shared_buffers`, `port`, `max_connections`), потребуется **перезапуск**.

---

## 3. Подключение дополнительных файлов конфигурации

В конце `postgresql.conf` обычно присутствуют директивы:

* `include_dir = 'conf.d'` — подключить все файлы из указанной директории;
* `include = 'файл.conf'` — подключить отдельный файл;
* `include_if_exists = 'файл.conf'` — подключить файл, если он существует.

Эти возможности позволяют:

* разделить конфигурацию по тематическим файлам;
* хранить дополнительные настройки отдельно;
* безопасно обновлять отдельные параметры.

Если параметр встречается несколько раз — применяется **последнее прочитанное значение**.

---

## 4. Просмотр настроек через системные представления

PostgreSQL хранит всю информацию о конфигурации в системных представлениях:

### `pg_file_settings`

Показывает содержимое конфигурационных файлов и указывает:

* номер строки;
* источник (имя файла);
* значение;
* флаг `applied` (применено ли изменение);
* наличие ошибок.

Это помогает найти ошибки (например, опечатку в параметре) без чтения логов.

### `pg_settings`

Содержит **текущие значения** всех параметров, включая:

* `setting` — актуальное значение;
* `boot_val` — значение по умолчанию;
* `source` — откуда получено (файл, SQL-команда, значение по умолчанию);
* `pending_restart` — нужно ли перезапустить сервер для применения;
* `context` — где допускается изменение (`postmaster`, `sighup`, `superuser`, `user`).

Параметр `context` особенно важен:

* **internal** — нельзя изменить;
* **postmaster** — требуется перезапуск;
* **sighup** — достаточно перечитать конфигурацию;
* **superuser/user** — можно изменить в сеансе.

---

## 5. Файл `postgresql.auto.conf` и команда `ALTER SYSTEM`

PostgreSQL предоставляет SQL-интерфейс для управления конфигурацией — команду:

```sql
ALTER SYSTEM SET параметр TO значение;
```

Она изменяет **не** `postgresql.conf`, а отдельный файл — `postgresql.auto.conf`, который:

* всегда находится в каталоге данных (`PGDATA`);
* считывается **после** всех остальных конфигураций;
* не предназначен для ручного редактирования.

Изменения вступают в силу после перечитывания конфигурации:

```sql
SELECT pg_reload_conf();
```

Для удаления строк:

```sql
ALTER SYSTEM RESET параметр;
-- или
ALTER SYSTEM RESET ALL;
```

Таким образом, `ALTER SYSTEM` — безопасный и контролируемый способ изменять глобальные настройки без прямого доступа к файловой системе.

---

## 6. Изменение параметров во время сеанса

Некоторые параметры можно менять прямо в процессе работы сервера, не затрагивая глобальные файлы.

### Основные команды

* `SET параметр TO значение;` — изменить параметр до конца сеанса;
* `SET LOCAL параметр TO значение;` — только до конца текущей транзакции;
* `RESET параметр;` — вернуть значение, действовавшее при старте сеанса.

Аналогичные функции:

```sql
SELECT set_config('work_mem', '32MB', false);
SELECT current_setting('work_mem');
```

### Особенности

* Изменения **транзакционны** — при `ROLLBACK` параметры возвращаются к предыдущим значениям.
* При `SET LOCAL` эффект сохраняется только внутри текущей транзакции.
* Эти механизмы полезны при работе через **пулы соединений**, где один сеанс может использоваться разными пользователями.

---

## 7. Пользовательские параметры

PostgreSQL позволяет создавать **собственные параметры**, не входящие в системный набор.

Пример:

```sql
SELECT set_config('myapp.currency_code', 'RUB', false);
```

Имена пользовательских параметров **обязательно должны содержать точку** (например, `myapp.`), чтобы отличаться от системных.

Такие переменные можно:

* использовать как глобальные переменные в приложении;
* хранить значения сеансовых настроек;
* задавать в конфигурационных файлах для автоматической инициализации.

---

## 8. Установка параметров при подключении клиента

Если приложение использует стандартную библиотеку **libpq**, параметры можно задать ещё до установления соединения:

1. Через **строку подключения**:

   ```
   psql "options='-c work_mem=32MB'"
   ```

2. Через **переменную окружения**:

   ```bash
   export PGOPTIONS='-c work_mem=32MB'
   psql
   ```

Эти методы удобны, когда нужно временно изменить поведение клиента без правки серверных файлов.

---

## 9. Где сервер находит конфигурационные файлы

Когда PostgreSQL запускается, он должен знать, где находится основной конфигурационный файл.
Этот путь задаётся:

* либо параметром `config_file` в командной строке запуска;
* либо автоматически, если сервер запущен из каталога данных (`PGDATA`).

В дистрибутивах вроде Ubuntu путь к `postgresql.conf` задаётся в **аргументах запуска** процесса `postgres`.
Посмотреть их можно командой:

```bash
ps -p <PID> -ho command
```

Идентификатор PID берётся из файла `postmaster.pid` в каталоге данных.

---

## 10. Итоги

* Основной файл настроек PostgreSQL — **`postgresql.conf`**.
* Можно подключать **дополнительные файлы** через `include` или `include_dir`.
* SQL-команда **`ALTER SYSTEM`** управляет параметрами через файл `postgresql.auto.conf`.
* Изменения в конфигурационных файлах требуют перечитывания (`pg_reload_conf()`) или перезапуска.
* Многие параметры можно менять **внутри сеанса** (`SET`, `SET LOCAL`, `RESET`).
* Возможно создание **пользовательских параметров**, используемых приложениями.
* Параметры можно задавать **при подключении клиента** или через переменные окружения.
