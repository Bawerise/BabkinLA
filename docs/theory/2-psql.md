# PostgreSQL: Использование терминального клиента **psql**

## 1. Назначение psql

**psql** — это стандартный терминальный клиент PostgreSQL, поставляемый вместе с самой СУБД.
Он используется для:

* интерактивной работы с базой данных;
* выполнения SQL-команд;
* запуска скриптов и автоматизации административных задач.

Хотя psql — текстовый инструмент и может показаться непривычным тем, кто работает с графическими оболочками (PgAdmin, DBeaver и др.), знание psql является важным навыком администратора и разработчика.
Именно он позволяет работать с PostgreSQL на любом сервере — локальном или удалённом, независимо от наличия графического интерфейса.

---

## 2. Подключение к серверу и базам данных

Для работы с psql необходимо установить соединение с сервером PostgreSQL.

### Параметры подключения

При запуске можно указать:

* **-d** — имя базы данных;
* **-U** — имя пользователя;
* **-h** — адрес узла (хоста);
* **-p** — номер порта (по умолчанию 5432).

Если параметры не заданы, psql использует значения по умолчанию:

* имя базы = имя пользователя;
* имя пользователя = имя учётной записи в ОС;
* соединение выполняется через локальный Unix-сокет;
* порт — 5432.

### Управление соединением

* Для переключения между базами без выхода из psql используется команда `\connect` (или `\c`).
* Текущие параметры подключения можно посмотреть с помощью `\conninfo`.

---

## 3. Получение справочной информации

### В операционной системе

* `psql --help` — краткая справка по запуску;
* `man psql` — страница руководства, если установлена документация.

### Внутри psql

psql имеет собственные команды (начинаются с обратной косой черты `\`):

* `\?` — список всех команд psql;
* `\? variables` — список встроенных переменных psql;
* `\h` — список SQL-команд, поддерживаемых сервером;
* `\h <команда>` — синтаксис конкретной SQL-команды;
* `\q` — выход из psql (альтернатива: `exit`, `quit`).

Таким образом, psql позволяет получать справку без обращения к документации или интернету, что удобно при работе на удалённых системах.

---

## 4. Работа в интерактивном режиме

psql умеет выполнять как SQL-команды, так и собственные управляющие команды.
SQL-команды заканчиваются точкой с запятой `;`. Это сигнал для psql отправить их на выполнение серверу.

Результаты запроса можно представлять в различных форматах.
Основные режимы форматирования:

* **Выравненный (aligned)** — стандартный табличный вид;
* **Без выравнивания (unaligned)** — данные выводятся без границ таблицы, удобно для парсинга;
* **Расширенный (expanded)** — каждая строка выводится вертикально, по одному полю на строку (удобно при большом числе столбцов).

Режимы можно переключать командами:

* `\a` — включить/выключить выравнивание;
* `\t` — скрыть или показать заголовки и итоги;
* `\x` — включить/выключить расширенный формат;
* `\pset` — задать параметры вывода (разделители, границы, формат и т.д.).

---

## 5. Взаимодействие с операционной системой

psql позволяет выполнять команды операционной системы, не выходя из него.
Это удобно при работе на сервере или в учебных средах Linux.

* `\! <команда>` — выполнить команду оболочки (например, `\! pwd`);
* `\setenv` — установить переменную окружения;
* `\o [файл]` — направить вывод запросов в файл (для логирования или отчётов);
* `\o` без аргументов — вернуть вывод обратно на экран.

Такое взаимодействие делает psql мощным инструментом для администрирования, объединяя возможности SQL и командной строки.

---

## 6. Выполнение скриптов и перенаправление вывода

psql позволяет:

* выполнять команды из файла (`\i <путь>` или `psql -f <файл>`),
* передавать результаты запросов в файлы или системные команды.

Команда `\g` отправляет текущий запрос на выполнение.
Её можно использовать с параметрами форматирования или перенаправления вывода:

* `\g <файл>` — записать результат запроса в файл;
* `\g | <команда>` — передать результат внешней команде ОС;
* `\gexec` — выполнить результат запроса как SQL-команды (например, динамически сгенерированные операторы).

---

## 7. Переменные и управляющие конструкции psql

psql поддерживает собственные переменные и простейшие управляющие конструкции, аналогичные переменным оболочки Bash.

### Работа с переменными

* `\set <имя> <значение>` — установить переменную;
* `\unset <имя>` — удалить переменную;
* `\getenv <имя_psql> <имя_системной>` — скопировать значение переменной из ОС;
* `\echo :<имя>` — вывести значение переменной.

Можно записывать результаты SQL-запроса в переменные командой `\gset`.
Такие переменные могут использоваться в дальнейшем в выражениях и скриптах psql.

### Условные операторы

psql поддерживает простые конструкции `\if … \else … \endif`, которые можно применять в скриптах для проверки существования переменных или выполнения логических ветвлений.
Например, можно задать значение переменной по умолчанию, если она ещё не определена.

---

## 8. Команды для работы с системным каталогом

С помощью команд, начинающихся на `\d`, можно быстро получать информацию об объектах базы данных.

Наиболее часто используемые:

* `\d` — список таблиц и представлений;
* `\d <имя>` — описание конкретного объекта (структура таблицы, столбцы, типы и т.д.);
* `\dn`, `\dt`, `\dv`, `\df` — фильтры по типу объектов (схемы, таблицы, представления, функции).

Эти команды позволяют администраторам и разработчикам исследовать структуру базы данных без обращения к системным таблицам напрямую.

---

## 9. Настройка окружения psql

При запуске psql автоматически загружает два конфигурационных файла (если они существуют):

1. **Системный скрипт** `psqlrc` — общие настройки для всех пользователей (расположение можно узнать через `pg_config --sysconfdir`);
2. **Пользовательский файл** `~/.psqlrc` — индивидуальные настройки конкретного пользователя.

В этих файлах можно задать:

* вид приглашения (`PROMPT1`, `PROMPT2`, `PROMPT3`);
* параметры постраничного просмотра (`PSQL_PAGER`);
* переменные (`\set`, `\setenv`);
* включение отображения времени выполнения (`\timing on`);
* часто используемые запросы, сохранённые как переменные.

Благодаря библиотеке **readline**, psql поддерживает автодополнение и хранение истории команд.
История записывается в файл, указанный переменной `HISTFILE` (по умолчанию `~/.psql_history`).

---

## 10. Работа с транзакциями и обработка ошибок

psql по умолчанию работает в режиме **автоматической фиксации транзакций**: каждая SQL-команда выполняется как отдельная транзакция.

### Явные транзакции

Чтобы начать транзакцию вручную, используется команда `BEGIN`.
После этого несколько команд выполняются как единое целое и завершаются либо `COMMIT`, либо `ROLLBACK`.

Если в транзакции произошла ошибка, PostgreSQL переводит её в состояние *aborted* — дальнейшие команды внутри этой транзакции выполняться не будут.
Чтобы продолжить работу, необходимо завершить транзакцию (командой `COMMIT` или `ROLLBACK`).

### Переменная `ON_ERROR_ROLLBACK`

Для интерактивного режима psql можно включить автоматическую установку **точек сохранения** перед каждой SQL-командой.
Это делается через:

```psql
\set ON_ERROR_ROLLBACK on
```

В этом режиме при ошибке выполняется откат только последней неудавшейся команды, а не всей транзакции.
Это удобно при пошаговом тестировании в интерактивной сессии.

---

## 11. Итоги

* **psql** — универсальный терминальный клиент PostgreSQL, подходящий для администрирования и разработки.
* Он поддерживает как SQL-команды, так и собственные управляющие конструкции.
* Позволяет выполнять запросы, скрипты и команды ОС, форматировать результаты и использовать переменные.
* Настройки можно вынести в конфигурационные файлы, чтобы среда работы была удобной и предсказуемой.
* Владение psql — ключевой навык администратора PostgreSQL.
