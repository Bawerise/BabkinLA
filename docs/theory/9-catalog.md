# Системный каталог PostgreSQL

## 1. Назначение системного каталога

**Системный каталог** — это набор таблиц и представлений, в которых PostgreSQL хранит метаинформацию обо всех объектах кластера баз данных.
Он содержит сведения о базах данных, схемах, таблицах, индексах, функциях, ролях, типах данных и других элементах системы.

По сути, системный каталог — это «база данных о базе данных».
Любой объект, созданный в PostgreSQL, автоматически получает запись в одной или нескольких таблицах этого каталога.

### Основные схемы

* **`pg_catalog`** — основная схема системного каталога, содержащая таблицы и представления с информацией обо всех объектах PostgreSQL.
* **`information_schema`** — альтернативное представление, определённое стандартом SQL. Оно стабильнее и переносимее, но отражает не все возможности PostgreSQL.

### Доступ

* Все данные каталога доступны через обычные SQL-запросы (`SELECT`, `CREATE`, `ALTER`, `DROP`).
* Изменять системные таблицы напрямую не следует — это приведёт к повреждению структуры кластера.
* Для просмотра удобно использовать встроенные команды `psql`, начинающиеся с `\d` (от *describe*). Они формируют SQL-запросы к системным таблицам и выводят результаты в удобном виде.

### Где используется

К системному каталогу обращаются:

* сам сервер PostgreSQL при выполнении запросов;
* клиентские утилиты (`psql`, графические IDE);
* планировщик запросов и оптимизатор;
* пользователи, чтобы узнать структуру и свойства базы данных.

---

## 2. Общие и локальные объекты

В каждой базе данных кластера существует собственный набор таблиц системного каталога.
Он хранит только информацию, относящуюся к этой базе — её схемам, таблицам, функциям и т.д.

Однако часть таблиц является **общей для всего кластера** — например, список баз данных (`pg_database`) и общие настройки.
Эти таблицы хранятся вне отдельных баз, но доступны для чтения из любой базы кластера.

---

## 3. Правила именования объектов каталога

### Префиксы

* Все объекты системного каталога (таблицы и представления) имеют префикс **`pg_`**.
  Пользовательские объекты с таким префиксом создавать не рекомендуется — чтобы избежать конфликтов.
* Имена столбцов обычно начинаются с короткого трёхбуквенного префикса, соответствующего названию таблицы (например, `datname` в `pg_database`, `relname` в `pg_class`).

### Регистр

Названия объектов и столбцов хранятся **в нижнем регистре** независимо от регистра, использованного при создании.

---

## 4. Основные таблицы системного каталога

Каждый тип объекта в PostgreSQL описывается одной или несколькими таблицами каталога. Наиболее важные из них:

| Таблица                  | Назначение                                                            |
| ------------------------ | --------------------------------------------------------------------- |
| `pg_database`            | Список баз данных кластера и их параметры                             |
| `pg_namespace`           | Сведения о схемах                                                     |
| `pg_class`               | Информация о таблицах, индексах, представлениях и последовательностях |
| `pg_attribute`           | Описание столбцов таблиц и представлений                              |
| `pg_type`                | Список всех типов данных                                              |
| `pg_index`               | Информация об индексах                                                |
| `pg_proc`                | Описание функций и процедур                                           |
| `pg_roles` / `pg_authid` | Сведения о пользователях и ролях                                      |
| `pg_tables`, `pg_views`  | Системные представления для удобного доступа к объектам               |

Таблица `pg_class` играет центральную роль: она хранит записи обо всех объектах, которые в PostgreSQL называются общим словом *relation* — таблицы, индексы, представления, последовательности.
Связанные таблицы (`pg_attribute`, `pg_index`, `pg_namespace`) уточняют детали каждого объекта.

---

## 5. Системные представления

Для упрощения работы PostgreSQL предоставляет **представления**, которые объединяют данные из нескольких таблиц каталога.
Они позволяют получать готовую информацию без написания сложных соединений (`JOIN`).

Например:

* `pg_tables` — список всех таблиц в базе с указанием владельцев, пространств таблиц и признаков наличия индексов;
* `pg_views` — список представлений и их определений.

Эти представления часто используются встроенными командами `psql`, такими как `\dt`, `\dv`, `\d`.

---

## 6. Первичные ключи и связи между таблицами каталога

Почти все таблицы системного каталога содержат столбец **`oid`** — *object identifier*.
Он используется как уникальный идентификатор строк и часто служит **первичным ключом**.

Таблицы системного каталога связаны между собой аналогично обычным таблицам пользовательских баз:

* связи выражаются через поля-ссылки (`relowner`, `relnamespace`, `atttypid` и др.);
* для обеспечения ссылочной целостности используются специальные механизмы, аналогичные внешним ключам.

Пример:

* `pg_attribute.attrelid` ссылается на `pg_class.oid` (таблица, к которой относится столбец);
* `pg_attribute.atttypid` ссылается на `pg_type.oid` (тип данных столбца).

---

## 7. Специальные типы данных: `oid` и `reg*`

### Тип `oid`

Тип `oid` (object identifier) — это 32-битное целое число (до 4 млрд значений), используемое для идентификации объектов внутри кластера.
В системном каталоге столбцы `oid` автоматически создаются для большинства объектов.
Этот тип ведёт себя как автоинкрементный счётчик и гарантирует уникальность идентификатора в пределах всей системы.

### Семейство типов `reg*`

PostgreSQL предоставляет набор «расширенных» типов, начинающихся с `reg`:

* `regclass` — для объектов `pg_class` (таблицы, представления, индексы);
* `regtype` — для типов данных;
* `regproc` / `regprocedure` — для функций;
* `regnamespace` — для схем;
* `regrole` — для ролей;
* `regcollation`, `regconfig`, `regdictionary` — для дополнительных системных объектов.

Эти типы являются «псевдонимами» `oid`, но умеют автоматически преобразовывать **текстовые имена** в **идентификаторы** и обратно.

#### Пример применения

Обычный запрос к каталогу:

```sql
SELECT attname, atttypid
FROM pg_attribute
WHERE attrelid = (
  SELECT oid FROM pg_class WHERE relname = 'employees'
);
```

можно записать короче, используя `regclass`:

```sql
SELECT attname, atttypid
FROM pg_attribute
WHERE attrelid = 'employees'::regclass;
```

Здесь строка `'employees'` преобразуется в `oid` таблицы `employees`.
А чтобы обратно получить название типа, можно привести `oid` к `regtype`:

```sql
SELECT atttypid::regtype FROM pg_attribute ...;
```

---

## 8. Структура и целостность системного каталога

### Первичные и уникальные ключи

Начиная с PostgreSQL 14, для большинства таблиц системного каталога введены явные первичные ключи и ограничения уникальности.
Это улучшило внутреннюю целостность и упростило использование каталога в пользовательских запросах.

### Псевдо-внешние ключи

Связи между системными таблицами обеспечиваются специальными ограничениями, которые работают аналогично внешним ключам, но допускают:

* хранение ссылок в виде массивов;
* использование значения 0 для обозначения «неопределённой» ссылки.

---

## 9. Дополнительные инструменты доступа

В `psql` предусмотрены команды для быстрого просмотра информации из системного каталога:

| Команда          | Назначение                                                                 |
| ---------------- | -------------------------------------------------------------------------- |
| `\dt`            | список таблиц                                                              |
| `\dv`            | список представлений                                                       |
| `\df`            | список функций                                                             |
| `\dn`            | список схем                                                                |
| `\d имя_объекта` | подробное описание конкретного объекта                                     |
| `\d+`            | тот же вывод, но с дополнительными сведениями (размер, тип хранения и др.) |

Модификатор `S` добавляет системные объекты (`\dfS`, `\dtS` и т.п.).

Хотя эти команды не являются частью SQL, они формируют обычные запросы к системным таблицам, которые можно увидеть, включив переменную `ECHO_HIDDEN`.

---

## 10. Схема `information_schema`

Эта схема реализует стандарт SQL и предоставляет переносимый способ обращения к структуре базы данных.
Она содержит множество представлений, например:

* `information_schema.tables`
* `information_schema.columns`
* `information_schema.views`
* `information_schema.schemata`

В отличие от `pg_catalog`, эти представления не зависят от внутренних особенностей PostgreSQL и могут использоваться в приложениях, совместимых с другими СУБД.

---

## 11. Итоги

* **Системный каталог** хранит полное описание структуры и состояния кластера PostgreSQL.
* Основная схема — `pg_catalog`, альтернативная — `information_schema`.
* Часть таблиц каталога локальна для каждой базы данных, а часть общая для всего кластера.
* Все объекты системного каталога имеют префикс `pg_`.
* Идентификаторы объектов представлены типом `oid`, а семейство `reg*` позволяет обращаться к ним по имени.
* Для навигации и анализа структуры можно использовать как SQL-запросы, так и встроенные команды `psql`.
