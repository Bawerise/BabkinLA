# Табличные пространства в PostgreSQL

## 1. Назначение табличных пространств

В PostgreSQL **табличные пространства (tablespaces)** — это механизм, позволяющий управлять **физическим размещением данных** в файловой системе.

Они определяют, в каком каталоге (папке) на сервере будут храниться файлы таблиц, индексов и других объектов базы данных.

### Зачем это нужно

Табличные пространства позволяют:

* Разделять данные по разным физическим носителям (например, быстрые SSD для рабочих данных и медленные HDD для архивов);
* Контролировать распределение нагрузки на диски;
* Гибко управлять местом хранения данных без изменения логической структуры базы.

> **Пример**
> Можно создать одно табличное пространство для архивных таблиц (на медленных дисках), а другое — для часто используемых данных (на быстрых).

---

## 2. Табличные пространства по умолчанию

При инициализации нового кластера PostgreSQL автоматически создаются **два табличных пространства**:

| Имя              | Назначение                                                                                               |
| ---------------- | -------------------------------------------------------------------------------------------------------- |
| **`pg_default`** | Табличное пространство по умолчанию — сюда помещаются все объекты, если не указано иное.                 |
| **`pg_global`**  | Содержит общие системные данные, которые относятся ко всему кластеру (например, роли и общие настройки). |

Каждая база данных в кластере имеет **табличное пространство по умолчанию** — то есть то, где будут храниться все её объекты, если не указано другое при создании.

Изначально для всех баз данных используется `pg_default`, но при необходимости это можно изменить командой:

```sql
ALTER DATABASE имя SET TABLESPACE другое_табличное_пространство;
```

---

## 3. Табличные пространства и каталоги

Физически табличное пространство — это просто **каталог в файловой системе**, в котором PostgreSQL хранит файлы с данными.

Схема размещения:

```
PGDATA/
 ├─ base/          → pg_default (данные обычных баз)
 │   ├─ <oid>/     → каталоги отдельных баз
 ├─ global/        → pg_global (глобальные объекты)
 └─ pg_tblspc/     → ссылки на пользовательские табличные пространства
```

Когда создаётся пользовательское табличное пространство, PostgreSQL:

1. Использует указанный каталог как хранилище;
2. Создаёт **символическую ссылку** на этот каталог в `PGDATA/pg_tblspc/`;
3. Внутри каталога создаёт подкаталоги по версиям сервера (например, `PG_VERSION`, `16`, `17` и т.д.) — это нужно для удобства при обновлении PostgreSQL.

Каждый объект базы данных (таблица, индекс, последовательность и т.п.) хранится в **отдельном файле** внутри соответствующего каталога.

---

## 4. Пользовательские табличные пространства

Пользователь может создавать собственные табличные пространства.
Для этого требуется:

* Пустой каталог в файловой системе;
* Владельцем каталога должен быть системный пользователь `postgres`.

Команда создания:

```sql
CREATE TABLESPACE имя LOCATION '/путь/к/каталогу';
```

После создания новое табличное пространство можно назначить:

* для конкретной базы данных (`CREATE DATABASE ... TABLESPACE ...`);
* для отдельной таблицы или индекса (`CREATE TABLE ... TABLESPACE ...`);
* для временных объектов (через параметр `temp_tablespaces`).

---

## 5. Назначение табличного пространства для базы данных

При создании базы данных можно указать, в каком табличном пространстве она должна хранить свои объекты:

```sql
CREATE DATABASE appdb TABLESPACE ts;
```

Теперь все новые таблицы и индексы в этой базе будут размещаться в пространстве `ts`, если не указано иное.

Если табличное пространство не указано, используется **табличное пространство по умолчанию** для этой базы (обычно `pg_default`).

---

## 6. Табличные пространства для отдельных объектов

Для каждого объекта можно задать табличное пространство вручную:

```sql
CREATE TABLE orders (
  id serial PRIMARY KEY,
  amount numeric
) TABLESPACE fastspace;
```

То же самое справедливо и для индексов:

```sql
CREATE INDEX idx_orders_amount ON orders(amount) TABLESPACE fastspace;
```

Если в системном каталоге `pg_tables` или `pg_indexes` в поле `tablespace` стоит `NULL`, это означает, что объект находится в табличном пространстве **по умолчанию**.

---

## 7. Табличные пространства для временных таблиц

Для временных таблиц PostgreSQL позволяет задать отдельное пространство.
Это полезно, если вы хотите, чтобы временные данные создавались, например, на более быстрых SSD.

Параметр настройки:

```sql
SET temp_tablespaces = 'ts';
```

Можно указать несколько пространств через запятую — сервер выберет одно из них случайным образом.

---

## 8. Перемещение объектов между табличными пространствами

PostgreSQL позволяет **перемещать таблицы и индексы** из одного табличного пространства в другое.

```sql
ALTER TABLE имя SET TABLESPACE новое_пространство;
```

> ⚠️ При перемещении происходит **физическое копирование файлов данных**.
> На время операции объект блокируется и недоступен для чтения и записи.

Для индексов возможно перемещение и во время перестроения:

```sql
REINDEX (TABLESPACE новое_пространство) TABLE имя;
```

Чтобы переместить **все объекты из одного пространства в другое**, можно использовать:

```sql
ALTER TABLE ALL IN TABLESPACE старое SET TABLESPACE новое;
```

---

## 9. Измерение размера табличных пространств

Чтобы узнать, сколько места занимает табличное пространство:

```sql
SELECT pg_size_pretty(pg_tablespace_size('ts'));
```

Даже если кажется, что в нём немного данных, пространство может занимать значительный объём — потому что в нём хранятся **служебные объекты системного каталога** базы данных, для которой оно является пространством по умолчанию.

В `psql` список табличных пространств с их размерами можно посмотреть командой:

```
\db+
```

---

## 10. Удаление табличного пространства

Удалить табличное пространство можно только в том случае, если **в нём не осталось объектов**:

```sql
DROP TABLESPACE имя;
```

Команда `CASCADE` здесь не поддерживается, поскольку объекты табличного пространства могут принадлежать разным базам данных.
Перед удалением необходимо убедиться, что все таблицы, индексы и базы, использующие это пространство, перенесены или удалены.

### Порядок действий при удалении:

1. Найти идентификатор табличного пространства:

   ```sql
   SELECT oid FROM pg_tablespace WHERE spcname = 'ts';
   ```
2. Найти базы данных, в которых есть объекты из этого пространства:

   ```sql
   SELECT datname
   FROM pg_database
   WHERE oid IN (SELECT pg_tablespace_databases(<oid>));
   ```
3. В каждой из этих баз удалить или перенести объекты.
4. Если табличное пространство было «по умолчанию» для какой-либо базы, назначить другое:

   ```sql
   ALTER DATABASE имя SET TABLESPACE pg_default;
   ```
5. После этого табличное пространство можно безопасно удалить:

   ```sql
   DROP TABLESPACE ts;
   ```

---

## 11. Настройка параметров для табличных пространств

Для разных табличных пространств можно задавать **индивидуальные параметры**, влияющие на работу планировщика запросов.
Например, можно задать стоимость произвольного доступа к данным (важно для выбора плана выполнения запросов):

```sql
ALTER TABLESPACE fastspace SET (random_page_cost = 1.1);
```

Эта настройка сообщает планировщику, что чтение случайных страниц в данном пространстве почти так же быстро, как последовательное — типичная ситуация для SSD.

По умолчанию значения:

* `seq_page_cost = 1` (стоимость последовательного чтения);
* `random_page_cost = 4` (стоимость произвольного чтения, характерная для HDD).

Настройки сохраняются в таблице `pg_tablespace` и видны в `psql`:

```
\db+
```

---

## 12. Взаимосвязь логической и физической структуры

PostgreSQL разделяет данные на два уровня:

| Логический уровень                      | Физический уровень                                |
| --------------------------------------- | ------------------------------------------------- |
| Кластер → база данных → схема → таблица | Табличное пространство → каталог → файлы объектов |

Логическая структура определяет **что** хранится,
а табличные пространства — **где** это хранится в файловой системе.

Эти уровни **независимы**: перенос таблицы в другое табличное пространство не меняет ни её имени, ни схемы, ни содержимого с точки зрения SQL.

---

## 13. Итоги

* Табличные пространства управляют физическим расположением данных.
* При инициализации создаются два системных пространства: `pg_default` и `pg_global`.
* Каждая база данных имеет табличное пространство по умолчанию.
* Пользователь может создавать собственные табличные пространства и распределять между ними объекты.
* Перемещение между пространствами — физическая операция, требующая блокировки.
* Размеры и параметры табличных пространств можно просматривать и изменять через SQL.
* Логическое и физическое разделение данных в PostgreSQL независимы — это повышает гибкость и управляемость системы.
