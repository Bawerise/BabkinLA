# Резервное копирование в PostgreSQL

## 1. Введение

**Резервное копирование (backup)** — это создание копии данных, которая позволит восстановить их при сбое, ошибке пользователя или аппаратной неисправности.

В PostgreSQL существует **два основных подхода** к резервному копированию:

1. **Логическое резервное копирование** — сохранение структуры и содержимого базы данных в виде команд SQL.
2. **Физическое резервное копирование** — копирование файлов данных, из которых состоит кластер PostgreSQL, с возможностью восстановления на момент времени.

---

## 2. Логическое резервное копирование

### Что это такое

**Логическая копия** — это набор SQL-команд, которые позволяют заново создать базу данных, таблицы и заполнить их данными.
По сути, это текстовый файл, который можно выполнить в PostgreSQL и восстановить состояние базы.

**Преимущества:**

* можно копировать отдельные объекты (например, только одну таблицу);
* можно редактировать копию вручную;
* можно восстановить данные на другой версии PostgreSQL или другой архитектуре процессора.

**Недостатки:**

* низкая скорость при больших объемах данных;
* восстановление возможно только на момент создания копии.

---

### Копирование отдельной таблицы (команда COPY)

Команда `COPY` используется для быстрого экспорта и импорта данных таблицы.

#### Пример:

```sql
COPY table_name TO '/path/to/file.csv' WITH (FORMAT csv, HEADER);
```

Эта команда записывает содержимое таблицы в файл (на сервере).
Чтобы восстановить данные из файла:

```sql
COPY table_name FROM '/path/to/file.csv' WITH (FORMAT csv, HEADER);
```

#### Варианты:

* **Серверный вариант** (`COPY`) — работает с файлами на сервере (пользователь PostgreSQL должен иметь доступ к файлу).
* **Клиентский вариант** (`\copy` в `psql`) — работает с файлами на клиенте, где запущена программа `psql`.

#### Особенности:

* `COPY` намного быстрее, чем `INSERT`, так как обращение к серверу выполняется один раз.
* Пустая строка (`''`) и значение `NULL` — разные вещи.
  При экспорте `NULL` обозначается `\N`.

---

### Копирование базы данных (pg_dump)

Для резервного копирования всей базы данных используется утилита **`pg_dump`**.

#### Основные возможности:

* выгружает данные в виде SQL-скрипта или в специальный архивный формат;
* поддерживает параллельную работу (ускоряет процесс);
* можно выбрать, какие объекты выгружать (определенные схемы, таблицы и т. д.);
* можно сохранять только структуру (DDL) или только данные (DML).

#### Восстановление:

* если копия сделана в виде SQL-файла — её можно восстановить через `psql`;
* если копия в специальном формате — используется утилита `pg_restore`.

#### Важно:

* новую базу данных лучше создавать из шаблона `template0`, чтобы избежать попадания ненужных изменений;
* роли и табличные пространства, относящиеся ко всему кластеру, нужно создать заранее;
* после восстановления рекомендуется выполнить `ANALYZE` для обновления статистики.

---

### Копирование всего кластера (pg_dumpall)

Для резервирования **всего кластера** (всех баз данных, ролей и табличных пространств) применяется **`pg_dumpall`**.

#### Особенности:

* сохраняет всё: базы данных, роли, табличные пространства;
* создаёт один SQL-файл (другие форматы не поддерживаются);
* не поддерживает параллельное выполнение.

При необходимости можно выгрузить **только глобальные объекты** (роли, табличные пространства) с помощью параметра `--globals-only`, а базы данных сохранить отдельно через `pg_dump`.

---

## 3. Физическое резервное копирование

### Принцип работы

Физическое копирование создаёт **побайтовую копию файлов кластера** и **журналов предзаписи (WAL)**.
Это позволяет быстро восстановить систему и даже выбрать момент восстановления.

Физическая копия включает:

1. **Базовую резервную копию** — копию файлов данных.
2. **Журналы предзаписи (WAL)** — последовательность записей изменений, необходимых для восстановления согласованности.

Если сервер был корректно остановлен перед копированием, журналы WAL не нужны.
Если резервирование выполняется при работающем сервере, нужны все журналы, созданные за время копирования.

---

### Холодное и горячее резервирование

| Вид          | Когда выполняется         | Особенности                                   |
| ------------ | ------------------------- | --------------------------------------------- |
| **Холодное** | При остановленном сервере | Простое восстановление, но требует простоя.   |
| **Горячее**  | При работающем сервере    | Не требует остановки, но сложнее в настройке. |

Горячее копирование применяется чаще, так как позволяет выполнять резервное копирование без прерывания работы системы.

---

### Автономная резервная копия (pg_basebackup)

Утилита **`pg_basebackup`** создаёт автономную физическую копию, подключаясь к серверу по **протоколу репликации**.

#### Что делает pg_basebackup:

1. выполняет контрольную точку;
2. копирует файлы кластера баз данных;
3. добавляет в копию все сегменты WAL, созданные за время копирования.

#### В результате:

получается **автономная копия**, готовая к самостоятельному запуску — её достаточно развернуть и запустить PostgreSQL.

---

### Протокол репликации

Механизм `pg_basebackup` использует **репликационный протокол**, который обеспечивает передачу:

* файлов кластера,
* потока WAL-записей,
* команд управления копированием и репликацией.

#### Требования:

* параметр `wal_level` должен быть установлен в значение `replica`;
* роль должна иметь атрибут `REPLICATION` или быть суперпользователем;
* в `pg_hba.conf` должно быть разрешено подключение по протоколу репликации;
* параметр `max_wal_senders` задаёт количество параллельных процессов wal_sender.

---

## 4. Архивирование журналов (WAL)

Поскольку физическая копия может быть сделана только в определённый момент, чтобы обеспечить **непрерывное восстановление**, нужно сохранять и последующие журналы WAL.
Это называется **непрерывное архивирование (continuous archiving)**.

### Виды архивации

| Вид архива          | Описание                                                              | Особенности                                                                              |
| ------------------- | --------------------------------------------------------------------- | ---------------------------------------------------------------------------------------- |
| **Файловый архив**  | Сервер сам копирует сегменты WAL в архив, когда они заполняются.      | Прост в настройке, но возможны задержки — файл попадает в архив только после заполнения. |
| **Потоковый архив** | Внешняя утилита получает поток WAL-записей и записывает их постоянно. | Минимальные задержки, но требуется дополнительная настройка.                             |

---

### Файловый архив (параметр archive_command)

Архивация выполняется фоновым процессом **archiver**.

#### Основные параметры:

```ini
archive_mode = on
archive_command = 'cp %p /path/to/archive/%f'
```

* `%p` — путь к файлу WAL;
* `%f` — имя файла в архиве.

Если команда завершается успешно (статус `0`), сегмент удаляется.
Если команда возвращает ошибку, сервер будет повторять попытку до успеха.

---

### Потоковый архив (pg_receivewal)

Утилита **`pg_receivewal`** подключается по протоколу репликации и записывает поток WAL-записей в файлы.

#### Особенности:

* может использовать **слот репликации**, чтобы избежать потери сегментов;
* записывает данные постоянно (не дожидаясь заполнения сегмента);
* при первом запуске начинает с конца последнего заполненного сегмента или с начала текущего, если архив пуст.

> PostgreSQL не запускает `pg_receivewal` как службу — это делает операционная система.

---

## 5. Восстановление данных

### Варианты восстановления

1. **Из автономной копии (pg_basebackup):**
   просто развернуть копию и запустить сервер.

2. **Из базовой копии и архива WAL:**
   дополнительно нужно:

   * задать параметр `restore_command` — команду копирования файлов из архива;
   * указать целевую точку восстановления;
   * создать файл `recovery.signal`, чтобы сервер вошёл в режим восстановления.

Пример `restore_command`:

```ini
restore_command = 'cp /archive/%f %p || cp /archive/%f.partial %p'
```

Когда восстановление завершено, сервер начинает обычную работу и может стать новым основным сервером.

---

## 6. Итоги

| Вид резервного копирования | Инструменты                        | Особенности                                                                 |
| -------------------------- | ---------------------------------- | --------------------------------------------------------------------------- |
| **Логическое**             | `COPY`, `pg_dump`, `pg_dumpall`    | Гибкое, переносимое, но медленное.                                          |
| **Физическое**             | `pg_basebackup`                    | Быстрое, можно восстановить на определённый момент, но только весь кластер. |
| **Архив журналов**         | `archive_command`, `pg_receivewal` | Позволяет восстановить систему на любой момент времени.                     |
