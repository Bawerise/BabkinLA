# Архитектура PostgreSQL

## 1. Общие сведения

**PostgreSQL** — это клиент-серверная система управления базами данных.
Она состоит из двух частей:

* **Сервер**, управляющий хранилищем данных и выполняющий SQL-запросы;
* **Клиенты**, которые подключаются к серверу, посылают запросы и получают результаты.

Работа PostgreSQL построена на **сетевом протоколе** — это соглашение о том, как клиент и сервер обмениваются данными. Благодаря этому можно подключаться к серверу с любого устройства и на любом языке программирования, если есть соответствующий драйвер.

---

## 2. Принцип работы клиент–сервер

Когда клиент (например, утилита `psql`, Python-приложение с библиотекой `psycopg2`, или Java через JDBC) подключается к серверу:

1. Сервер выполняет **аутентификацию** — проверяет права доступа (часто с использованием пароля или файла настроек `pg_hba.conf`);
2. Клиент отправляет SQL-запросы;
3. Сервер выполняет запросы и возвращает результаты.

Клиент не взаимодействует с файлами базы данных напрямую — он передает команды серверу, который управляет всеми операциями, обеспечивает согласованность данных и поддержку транзакций.

---

## 3. Транзакции и их свойства

**Транзакция** — это последовательность операций, которые должны выполняться как единое целое.
Цель — гарантировать согласованность данных, даже если что-то пойдет не так (например, сбой питания или конфликт между пользователями).

### Свойства ACID:

* **Атомарность (Atomicity):** все операции внутри транзакции выполняются полностью или не выполняются вовсе. Если возникает ошибка, можно выполнить `ROLLBACK`, чтобы отменить изменения.
* **Согласованность (Consistency):** база данных всегда остается в допустимом состоянии, соблюдая все ограничения целостности (внешние ключи, уникальность и т.д.).
* **Изоляция (Isolation):** параллельные транзакции не мешают друг другу; каждая видит согласованные данные.
* **Долговечность (Durability):** зафиксированные (`COMMIT`) изменения не теряются даже при сбое, так как записываются в журнал WAL.

Транзакция начинается командой:

```sql
BEGIN;
```

и завершается одной из:

```sql
COMMIT;   -- зафиксировать изменения
ROLLBACK; -- отменить изменения
```

---

## 4. Выполнение запроса

Когда клиент отправляет SQL-запрос, сервер проходит несколько этапов:

1. **Разбор (Parsing):** проверка синтаксиса и структуры запроса.
   На этом этапе используется **системный каталог** — набор внутренних таблиц PostgreSQL, где хранится информация обо всех объектах базы данных.
2. **Переписывание (Rewriting):** преобразование запроса, например, раскрытие представлений (`VIEW`) или применение правил.
3. **Планирование (Planning):** сервер выбирает оптимальный способ выполнения запроса — какие индексы использовать, как соединять таблицы и т.д. Планировщик опирается на статистику о размере таблиц и распределении данных.
4. **Выполнение (Execution):** чтение данных и формирование результата для клиента.

SQL — язык **декларативный**, то есть пользователь описывает, *что* нужно получить, а сервер сам решает, *как* это сделать.

---

## 5. Подготовленные операторы

Если один и тот же запрос выполняется многократно, PostgreSQL может сохранить его промежуточное представление — **подготовленный оператор** (prepared statement).

Механизм позволяет выполнить разбор и переписывание запроса один раз, а затем многократно использовать уже готовую структуру с разными параметрами.

### Преимущества:

* Повышение производительности при повторных запросах;
* Защита от SQL-инъекций, так как параметры передаются отдельно от текста запроса.

Пример:

```sql
PREPARE get_user(integer) AS
  SELECT * FROM users WHERE id = $1;

EXECUTE get_user(5);
```

---

## 6. Курсоры

Если результат запроса содержит много строк, можно получать их **постепенно**, а не все сразу.
Для этого используется **курсор** — механизм, позволяющий извлекать результаты по частям.

Пример:

```sql
BEGIN;
DECLARE c CURSOR FOR SELECT * FROM big_table ORDER BY id;
FETCH 10 c;   -- получить 10 строк
CLOSE c;
COMMIT;
```

Курсор — это своего рода «окно» в результат запроса.
Он экономит память и полезен для обработки больших таблиц или при передаче данных по сети.

---

## 7. Архитектура процессов

Сервер PostgreSQL состоит из нескольких взаимодействующих процессов.

### Основные компоненты:

* **Postmaster** — главный процесс, который запускает все остальные и следит за их состоянием. При сбое он может перезапустить сервер.
* **Backend** — отдельный процесс, обслуживающий подключённого клиента. Каждый клиент получает свой backend.
* **Фоновые процессы** — обеспечивают служебные функции (запись данных на диск, очистку, репликацию и т.д.).

### Память

* **Общая память** — используется всеми процессами (например, для буферного кеша страниц).
* **Локальная память** — индивидуальная область каждого backend-процесса (там хранятся состояние курсоров, планы запросов и кеш системного каталога).

---

## 8. Многопользовательская работа и многоверсионность (MVCC)

При подключении большого числа клиентов сервер создаёт для каждого свой процесс.
Чтобы избежать конфликтов при одновременной работе с данными, PostgreSQL применяет механизм **многоверсионного управления конкурентным доступом (MVCC)**.

Суть MVCC:

* Каждая транзакция видит "снимок" данных на момент своего начала;
* Изменения других транзакций становятся видимыми только после их фиксации;
* Разные версии одной и той же строки могут существовать одновременно, но каждая транзакция видит только свою версию.

Это позволяет:

* избегать блокировок при чтении;
* обеспечивать изоляцию без потери производительности.

---

## 9. Пул соединений

Каждое соединение требует выделения памяти и запуска отдельного процесса.
Если клиентов много, нагрузка на сервер возрастает.
Чтобы избежать избыточных затрат, используется **пул соединений**.

### Принцип:

Менеджер пула (например, `pgBouncer`) держит ограниченное число активных соединений с сервером и перераспределяет их между клиентами.
Для приложения это выглядит как обычное подключение, но с точки зрения PostgreSQL количество backend-процессов ограничено.

Пулы соединений:

* сокращают накладные расходы при частых подключениях;
* позволяют временно приостанавливать работу клиентов при перезапуске сервера без разрыва соединения.

---

## 10. Хранение данных

Данные в PostgreSQL хранятся в **файлах операционной системы**.

* Каждый файл разбит на **страницы** (обычно по 8 КБ);
* Внутри страницы есть заголовок и область данных;
* Изменения записываются не сразу, а сначала в **буферный кеш** в памяти.

Буферный кеш позволяет избежать повторных обращений к диску и ускоряет работу.
Физическая запись на диск выполняется позже — либо когда страница вытесняется из кеша, либо при контрольной точке.

---

## 11. Журнал WAL

Чтобы данные не терялись при сбое (например, при отключении питания), PostgreSQL использует **журнал предзаписи (Write-Ahead Log, WAL)**.

Все изменения сначала фиксируются в WAL, а потом применяются к основным файлам данных.
При перезапуске сервера система может «воспроизвести» журнал и восстановить базу данных в согласованное состояние.

Журнал и буферный кеш — центральные механизмы обеспечения долговечности и надежности.

---

## 12. Расширяемость системы

Одна из сильных сторон PostgreSQL — **открытая архитектура**.
СУБД спроектирована так, чтобы её можно было расширять без изменения ядра.

Можно добавлять:

* новые типы данных и операторы;
* собственные функции, триггеры и агрегаты;
* пользовательские языки программирования (PL/Perl, PL/Python, PL/v8 и др.);
* новые типы индексов (например, GiST, GIN, BRIN);
* фоновые процессы;
* интерфейсы к внешним источникам данных (через **FDW — Foreign Data Wrapper**).

Большинство расширений устанавливаются без перезапуска сервера.
Существует большое сообщество разработчиков расширений — многие из них публикуются в [pgxn.org](https://pgxn.org/).

---

## 13. Краткие выводы

* PostgreSQL — клиент–серверная система, где сервер управляет кластером баз данных.
* Каждый клиент обслуживается отдельным процессом backend.
* Все операции с дисками проходят через ОС, с использованием буферного кеша.
* Транзакции обеспечивают целостность данных, а механизм MVCC — эффективную изоляцию параллельных операций.
* Расширяемость и поддержка пользовательских типов, индексов и языков делают PostgreSQL универсальной и гибкой платформой для хранения данных.
