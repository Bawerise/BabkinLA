# Логическая репликация в PostgreSQL

## 1. Общие сведения

**Логическая репликация** — это механизм обмена изменениями данных между серверами PostgreSQL, основанный не на копировании файлов, а на передаче **изменений отдельных строк таблиц**.

В отличие от **физической репликации**, где копируются страницы данных и вся структура базы, логическая репликация работает на более высоком уровне — уровне SQL-таблиц. Это делает её более гибкой и независимой от версии PostgreSQL или архитектуры операционной системы.

---

## 2. Основная идея

При логической репликации взаимодействие строится по модели **публикация — подписка**.

* **Публикующий сервер** отслеживает изменения в таблицах (INSERT, UPDATE, DELETE, TRUNCATE), декодирует их в логический формат и отправляет подписчикам.
* **Сервер-подписчик** принимает эти изменения и применяет их к своим таблицам.

Оба сервера — полноценные PostgreSQL, они могут выполнять операции записи и чтения, а также участвовать в нескольких потоках репликации одновременно (например, быть и издателем, и подписчиком).

Такой подход позволяет:

* реплицировать только нужные таблицы или их части;
* передавать изменения между разными версиями PostgreSQL;
* организовывать репликацию в обе стороны между серверами.

---

## 3. Механизм работы

На публикующем сервере процесс **`wal_sender`** читает записи WAL (журналы предзаписи), но перед отправкой преобразует их из внутреннего двоичного формата в «логический» — человеко- и платформо-независимый.

На стороне подписчика процесс **`logical replication worker`** принимает поток изменений и применяет их к таблицам.

> Важно: подписчик может получать поток изменений не только от самого публикующего сервера, но и от его физической реплики. Это позволяет снизить нагрузку на основной сервер.

---

## 4. Публикации и подписки

### Публикация

Публикация — это набор таблиц (или их частей), за изменениями которых сервер будет следить и рассылать данные подписчикам.

Основные возможности публикации:

* выбор конкретных таблиц;
* фильтрация строк по условию (с версии 15);
* выбор отдельных столбцов для передачи;
* поддержка команд INSERT, UPDATE, DELETE и TRUNCATE;
* использование **слота логической репликации**, который обеспечивает передачу данных в нужной последовательности.

### Подписка

Подписка — это механизм на принимающем сервере, который подключается к публикации и применяет полученные изменения.

Характеристики подписки:

* может выполнять начальную синхронизацию данных при создании;
* применяет изменения построчно (без разбора SQL-команд);
* не пересоздаёт объекты — таблицы должны существовать заранее;
* при несовпадении данных возможны **конфликты**, которые нужно разрешать вручную.

> Таким образом, публикация — это источник изменений, а подписка — их получатель.

---

## 5. Уровни журнала WAL

Чтобы логическая репликация могла работать, PostgreSQL должен сохранять в журнале **дополнительную информацию о строках и таблицах**.
Эта настройка задаётся параметром `wal_level`.

| Уровень   | Назначение                                                               |
| --------- | ------------------------------------------------------------------------ |
| `minimal` | Минимальные данные для восстановления после сбоя. Репликация невозможна. |
| `replica` | Данные для физической репликации и восстановления из резервной копии.    |
| `logical` | Полная информация для логической репликации. Требуется для публикаций.   |

> Для логической репликации на публикующем сервере `wal_level` должен быть установлен в `logical`.

---

## 6. Идентификация строк и конфликты

Когда обновляется или удаляется строка, PostgreSQL должен определить, **какую именно строку** изменить на подписчике.
Для этого используется механизм **replica identity** — способ идентификации строк.

Возможные варианты:

* **PRIMARY KEY** — используется по умолчанию;
* **уникальный индекс с ограничением NOT NULL**;
* **все столбцы** (если нет уникальных ключей);
* **без идентификации** — для системных таблиц.

### Конфликты

Проблемы возникают, если данные на подписчике изменяются независимо — например, при попытке вставить строку с тем же первичным ключом, что и на публикующем сервере.

В этом случае:

* происходит **конфликт целостности**;
* репликация **приостанавливается**, пока администратор вручную не устранит проблему;
* после устранения конфликтов процесс применения изменений продолжается.

---

## 7. Ограничения логической репликации

Логическая репликация не является полной заменой физической. У неё есть ряд ограничений.

### Не реплицируются:

* команды DDL (`CREATE`, `ALTER`, `DROP` и др.);
* значения последовательностей (`SERIAL`, `BIGSERIAL`);
* большие объекты (`lo`);
* изменения представлений, материализованных представлений и внешних таблиц.

### Не поддерживается:

* автоматическое разрешение конфликтов.

### Последствия:

* изменения схемы данных нужно применять вручную;
* при использовании последовательностей возможны пересечения значений — это решается разделением диапазонов или использованием UUID.

---

## 8. Особенности и потенциальные проблемы

### Ссылочная целостность

Если таблица очищается с помощью `TRUNCATE`, то в публикацию нужно включить все таблицы, на которые ссылаются внешние ключи. Иначе целостность данных будет нарушена.

### Необходимость постоянного соединения

Подписка требует устойчивого соединения с публикацией.
Если соединение прерывается, **репликационный слот** становится неактивным и заставляет сервер хранить старые файлы WAL до восстановления связи.
Это может привести к переполнению диска.

### Массовые изменения

Каждое изменение строки передаётся отдельно.
Команды, затрагивающие много строк (`UPDATE ... WHERE`, `DELETE ... WHERE`), создают высокую нагрузку на сеть и подписчика.

### Долгие транзакции

Публикация передаёт изменения только после фиксации транзакции.
Если транзакция большая, это задерживает обновления на подписчике.
Параметр `streaming` позволяет передавать изменения частями, без ожидания завершения транзакции.

---

## 9. Типичные сценарии использования

### 1. Консолидация данных

Логическая репликация позволяет объединять данные из нескольких филиалов или региональных серверов в центральную базу.
Региональные серверы публикуют свои данные, а центральный — подписывается и собирает информацию для аналитики или отчетов.

Обратная схема (из центра в регионы) также возможна — например, для передачи справочников или настроек.

---

### 2. Обновление серверов без простоя

При переходе на новую основную версию PostgreSQL физическая репликация не подходит, поскольку разные версии несовместимы на уровне бинарных файлов.
Логическая репликация позволяет настроить публикацию на старом сервере и подписку на новом, обеспечив плавную миграцию без остановки обслуживания.

Процесс включает:

1. создание нового сервера с нужной версией;
2. настройку логической репликации;
3. синхронизацию данных;
4. переключение клиентов на новый сервер.

---

### 3. Двунаправленная репликация (master-master)

С версии **PostgreSQL 16** появилась возможность организовать репликацию «в обе стороны» — когда оба сервера одновременно публикуют и подписываются на одни и те же таблицы.

Такой режим полезен для географически распределённых систем, где запись может происходить в разных точках.

Однако:

* необходимо исключить конфликты (например, разделить диапазоны ключей или использовать UUID);
* PostgreSQL не поддерживает глобальные распределённые транзакции — согласованность обеспечивается на уровне приложения;
* автоматическое управление сбоями и переключениями отсутствует — требуется внешнее ПО.

---

## 10. Итоги

Логическая репликация:

* передаёт изменения **на уровне строк таблиц**, а не файлов;
* поддерживает **направленную и двунаправленную** синхронизацию;
* работает **между разными версиями PostgreSQL**;
* основана на **модели публикация — подписка**;
* имеет **ограничения**, особенно при сложных схемах данных.
