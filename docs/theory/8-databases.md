# Организация данных: базы данных и схемы в PostgreSQL

## 1. Кластер баз данных

### Что такое кластер

В PostgreSQL **кластер** — это совокупность всех баз данных, управляемых одним сервером PostgreSQL (одним экземпляром `postgres`).
Все базы внутри кластера используют **общий набор настроек, пользователей и системных каталогов**, но каждая база имеет **собственные данные** и внутренние объекты.

### Инициализация кластера

При создании нового кластера (например, командой `initdb`) PostgreSQL автоматически создаёт **три базы данных**:

| База данных | Назначение                                                                                                                                                       |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `template0` | Эталонная (базовая) копия, не должна изменяться. Используется при создании новых баз с другой кодировкой или при восстановлении из резервной копии.              |
| `template1` | Шаблон, из которого создаются все новые базы данных по умолчанию. Можно добавлять в неё расширения и объекты, чтобы они автоматически копировались в новые базы. |
| `postgres`  | База данных для подключения по умолчанию (используется многими утилитами). Не обязательна, но рекомендуется не удалять.                                          |

Таким образом, любая новая база данных создаётся **путём копирования** существующей (обычно — `template1`).

---

## 2. Базы данных в кластере

Каждая база данных:

* хранит свои объекты (таблицы, представления, функции и т.д.);
* имеет собственный набор схем;
* не может напрямую обращаться к данным других баз (только через внешние подключения).

Список всех баз можно получить:

```sql
SELECT datname, datistemplate, datallowconn, datconnlimit FROM pg_database;
```

| Поле            | Значение                                                         |
| --------------- | ---------------------------------------------------------------- |
| `datistemplate` | является ли база шаблоном (`true` для `template0` и `template1`) |
| `datallowconn`  | разрешено ли подключение                                         |
| `datconnlimit`  | ограничение по числу подключений (-1 — без ограничений)          |

---

## 3. Создание и управление базами данных

### Создание базы данных

Новая база создаётся командой:

```sql
CREATE DATABASE имя_базы;
```

По умолчанию используется шаблон `template1`.
Можно указать другой шаблон:

```sql
CREATE DATABASE имя_базы TEMPLATE template0;
```

### Изменение базы данных

* **Переименование:**

  ```sql
  ALTER DATABASE имя RENAME TO новое_имя;
  ```
* **Ограничение числа подключений:**

  ```sql
  ALTER DATABASE имя CONNECTION LIMIT 10;
  ```

### Удаление базы

Удалить базу можно только из другой базы данных:

```sql
DROP DATABASE имя;
```

---

## 4. Размер базы данных

PostgreSQL позволяет узнать, сколько места занимает база:

```sql
SELECT pg_database_size('имя');
```

или в удобочитаемом виде:

```sql
SELECT pg_size_pretty(pg_database_size('имя'));
```

Даже «пустая» база занимает несколько мегабайт — это служебные объекты и системные таблицы.

---

## 5. Схемы: организация пространства имён

### Что такое схема

**Схема** — это логическая «папка» внутри базы данных, предназначенная для хранения объектов (таблиц, функций, представлений и т.д.).
Каждый объект в PostgreSQL принадлежит какой-либо схеме.

Зачем нужны схемы:

* разделяют объекты на логические группы (например, `app`, `analytics`, `auth`);
* предотвращают конфликты имён между разными приложениями или пользователями;
* позволяют задавать разные права доступа к наборам объектов.

> ⚠️ Схема и пользователь — **разные сущности**.
> Однако, если создать схему с тем же именем, что и пользователь, PostgreSQL настроит её удобным образом для его работы.

---

## 6. Базы данных и схемы

Кластер состоит из нескольких баз, а каждая база — из нескольких схем.
Объекты распределены по схемам внутри базы данных.

Стандартные схемы, существующие в любой базе:

| Схема                | Назначение                                                                              |
| -------------------- | --------------------------------------------------------------------------------------- |
| `pg_catalog`         | хранит системный каталог PostgreSQL (служебные таблицы `pg_*`, представления и функции) |
| `public`             | стандартная «общая» схема для пользовательских объектов                                 |
| `information_schema` | стандартная по SQL схема с описанием структуры базы данных                              |

Пользователь может создавать собственные схемы:

```sql
CREATE SCHEMA app;
```

---

## 7. Как PostgreSQL ищет объекты: путь поиска (`search_path`)

Если объект указан без схемы (например, `SELECT * FROM t;`), сервер ищет его **поочерёдно** в схемах, заданных в пути поиска.

### Пример:

```sql
SHOW search_path;
```

Результат по умолчанию:

```
"$user", public
```

Это означает:

1. PostgreSQL сначала ищет схему, совпадающую с именем пользователя;
2. Если её нет, переходит к схеме `public`.

Фактический путь можно узнать функцией:

```sql
SELECT current_schemas(true);
```

### Изменение пути поиска

Путь можно задать на разных уровнях:

* для текущего сеанса:

  ```sql
  SET search_path = public, app;
  ```
* для всей базы данных:

  ```sql
  ALTER DATABASE имя SET search_path = public, app;
  ```

Теперь при подключении к этой базе PostgreSQL будет использовать указанный порядок поиска.

> Первая схема в `search_path` используется по умолчанию для создания новых объектов.

---

## 8. Специальные схемы

### `pg_catalog`

Содержит системные таблицы и представления, необходимые для работы PostgreSQL.
Даже если не указать её в `search_path`, она **всегда проверяется первой**.

### `public`

По умолчанию используется для всех пользовательских объектов, если не задана другая схема.

### Схема с именем пользователя

Может быть создана вручную. Если существует, она **входит в путь поиска автоматически** и используется для личных объектов пользователя.

---

## 9. Временные таблицы и временные схемы

PostgreSQL поддерживает **временные таблицы**, которые:

* существуют только в рамках сеанса или транзакции;
* не журналируются (не восстанавливаются после сбоя);
* не используют общий буферный кеш — работают быстрее, но менее надёжно.

При создании временной таблицы автоматически создаётся временная схема `pg_temp_N` (где `N` — номер сеанса).
Обращаться к ней можно через псевдоним `pg_temp`.

> Если `pg_temp` не указана в `search_path`, PostgreSQL всё равно рассматривает её первой.

После завершения сеанса:

* все объекты во временной схеме удаляются;
* сама схема остаётся для последующего использования другими сеансами.

---

## 10. Удаление объектов

* Схему нельзя удалить, если в ней есть объекты:

  ```sql
  DROP SCHEMA app;
  ```

  выдаст ошибку.

* Чтобы удалить схему **вместе со всеми объектами**, используйте:

  ```sql
  DROP SCHEMA app CASCADE;
  ```

---

## 11. Иерархия хранения данных

PostgreSQL организует данные **в три логических уровня:**

```
кластер
 └── база данных
      └── схема
           └── объект (таблица, индекс, функция и т.п.)
```

### Основные принципы

* Все базы в кластере независимы друг от друга.
* Новые базы создаются клонированием шаблонов (`template0`, `template1`).
* Схемы внутри базы разделяют пространство имён объектов.
* Поиск объектов управляется параметром `search_path`.
* Некоторые схемы (например, `pg_catalog`, `public`, `pg_temp`) имеют специальное назначение.

---

## 12. Выводы

1. Кластер PostgreSQL содержит несколько баз данных, каждая из которых независима.
2. Новые базы создаются из шаблонов, обычно `template1`.
3. Внутри базы данные организованы по схемам, которые выполняют роль пространств имён.
4. Путь поиска `search_path` определяет, в каких схемах искать объекты и где создавать новые.
5. Временные таблицы создаются во временных схемах (`pg_temp_N`) и автоматически удаляются после сеанса.
6. Структура «кластер → база данных → схема → объект» обеспечивает гибкость, масштабируемость и разделение прав доступа.
