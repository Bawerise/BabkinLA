# PostgreSQL: установка и управление сервером

## 1. Основные понятия

**PostgreSQL** — это система управления базами данных (СУБД).
Когда программа PostgreSQL запущена, она работает как **сервер** — служба, принимающая подключения клиентов и выполняющая SQL-запросы.

### Кластер баз данных

* **Кластер** — это совокупность всех баз данных, управляемых одним экземпляром сервера PostgreSQL.
* В кластере может быть несколько баз данных, но сервер всегда один, управляющий ими одновременно.
* **Файлы кластера** — это физические данные на диске.
* **Сервер PostgreSQL** — это процесс, управляющий этими файлами.

Иными словами, сервер — это программа, кластер — это данные, которыми она управляет.

---

## 2. Способы установки PostgreSQL

Есть два основных подхода:

1. **Из исходных кодов** — полезно для гибкости (особые настройки, нестандартные платформы).
2. **Из готовых пакетов** — предпочтительно для большинства случаев (быстро, безопасно, поддерживается системой обновлений).

---

## 3. Установка из исходных кодов

### Когда это нужно

* при необходимости задать нестандартные параметры сборки (например, изменить порт, включить отладку);
* если нужно собрать PostgreSQL под необычную архитектуру или систему;
* для разработчиков ядра, работающих с исходниками напрямую.

Исходный код можно взять:

* с официального сайта [postgresql.org/ftp/source](https://www.postgresql.org/ftp/source);
* из git-репозитория проекта.

### Инструменты, необходимые для сборки

**Обязательно:**

* `tar`, `gzip`/`bzip2` — распаковка архивов;
* `make` — система сборки;
* компилятор C (совместимый с C89).

**Желательно:**

* `readline` — для удобного редактирования команд в `psql`;
* `zlib`, `lz4`, `zstd` — для сжатия данных;
* `Perl`, `Python`, `Tcl` — если нужны встроенные языки процедур `PL/Perl`, `PL/Python`, `PL/Tcl`;
* `OpenSSL`, `Kerberos`, `OpenLDAP`, `PAM` — для аутентификации и шифрования;
* `ICU` — для поддержки Unicode.

Начиная с версии 16, PostgreSQL можно собирать как традиционно через **GNU Make**, так и через **Meson**.

### Общая идея процесса сборки

1. Распаковать исходники.
2. Настроить сборку (`configure`) — определить, где будет установлен сервер, какие опции включить.
3. Скомпилировать (`make`).
4. Установить (`make install`).

### Конфигурация сборки

Параметр `--prefix` задаёт каталог установки.
Пример: если вы не хотите использовать системный `/usr/local/pgsql`, можно установить PostgreSQL в домашний каталог пользователя.
Опция `--enable-debug` включает отладочную информацию, полезную при разработке.
Все параметры описаны в официальной документации.

---

## 4. Создание кластера баз данных

После установки сервер ещё не готов к работе — нужно **инициализировать кластер**.

### Утилита `initdb`

Эта программа создаёт структуру служебных файлов PostgreSQL, включая:

* системные таблицы;
* шаблонные базы данных;
* конфигурационные файлы (`postgresql.conf`, `pg_hba.conf`, и др.).

Особенности:

* Кластер не должен принадлежать суперпользователю ОС (обычно владельцем делают пользователя `postgres`).
* Удобно задать переменную окружения `PGDATA` — путь к каталогу с данными.
* При инициализации можно включить **контрольные суммы страниц** (`--data-checksums`), которые помогают обнаружить повреждения данных. Это немного снижает производительность, но повышает надёжность.

---

## 5. Управление сервером

### Утилита `pg_ctl`

Основные функции:

* запуск (`start`);
* останов (`stop`);
* получение статуса (`status`);
* перечитывание конфигурации (`reload`);
* переключение на реплику и другие действия.

Команды выполняются от имени владельца кластера.
`pg_ctl` — это универсальная управляющая утилита PostgreSQL.

---

## 6. Установка из пакетов

Использование готовых пакетов — **рекомендуемый способ** для большинства пользователей.

Преимущества:

* Установка и обновления выполняются стандартными средствами (`apt`, `yum`, `dnf` и др.);
* Настройки и расположение файлов соответствуют стандартам дистрибутива;
* Сервер автоматически добавляется в автозагрузку.

Пакеты доступны для:

* Linux (Debian, Ubuntu, Red Hat, SUSE и др.);
* FreeBSD, OpenBSD;
* macOS и Windows.

Сайт с официальными пакетами: [postgresql.org/download](https://www.postgresql.org/download/)

---

## 7. Кластер в пакетной установке (Ubuntu)

В Ubuntu используется собственная обёртка `pg_createcluster` — она выполняет ту же задачу, что `initdb`, но автоматически при установке пакета.

Особенности:

* создаётся кластер с именем `main`;
* контрольные суммы по умолчанию **не включаются**;
* файлы конфигурации и журнал сервера размещаются по правилам Ubuntu (`/etc/postgresql`, `/var/lib/postgresql`, `/var/log/postgresql`);
* сервер автоматически запускается при старте системы.

Удаление кластера выполняется через `pg_dropcluster`.

---

## 8. Управление сервером в Ubuntu

Здесь используется не `pg_ctl`, а обёртка **`pg_ctlcluster`**.
Она позволяет управлять несколькими версиями PostgreSQL, установленными в системе.

Параметры команды:

```
pg_ctlcluster <версия> <имя_кластера> <команда>
```

Примеры команд:

* `start` — запуск сервера;
* `stop` — останов;
* `restart` — перезапуск;
* `status` — проверка состояния;
* `reload` — перечитать конфигурацию.

Журналы сообщений PostgreSQL обычно хранятся в `/var/log/postgresql/`.

---

## 9. PostgreSQL в облаке и виртуальных средах

### Виртуальные машины

PostgreSQL может работать в виртуализированных средах, но виртуализация добавляет накладные расходы, поэтому для нагруженных систем предпочтительнее установка на физический сервер.

### PostgreSQL как сервис (DBaaS)

Многие облачные провайдеры предлагают PostgreSQL как управляемый сервис.
В этом случае:

* администрирование (резервное копирование, обновления, мониторинг) выполняет провайдер;
* пользователь имеет ограниченный доступ к настройкам и инструментам;
* полный контроль над сервером отсутствует.

---

## 10. Основные выводы

* PostgreSQL можно установить **из исходников** или **через пакеты**.
* При установке необходимо **инициализировать кластер баз данных**.
* Сервер работает от имени выделенного пользователя ОС (обычно `postgres`).
* Для управления сервером используются специальные утилиты (`pg_ctl`, `pg_ctlcluster`).
* Возможна работа PostgreSQL в облачных и виртуальных средах, но там ограничения по уровню доступа.
