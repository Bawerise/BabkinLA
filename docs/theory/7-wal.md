# Буферный кеш и журнал предзаписи (WAL)

## 1. Введение

Для эффективной и надёжной работы PostgreSQL использует два ключевых механизма:

* **Буферный кеш** — для ускорения доступа к данным;
* **Журнал предзаписи (WAL, Write-Ahead Log)** — для защиты данных от потери при сбоях.

Эти компоненты работают совместно: кеш повышает производительность, а журнал обеспечивает надёжность и возможность восстановления.

---

## 2. Буферный кеш

### Назначение

Буферный кеш — это область в общей памяти PostgreSQL, где временно хранятся страницы данных, прочитанные с диска или изменённые в ходе работы.
Он служит промежуточным звеном между быстрой оперативной памятью и более медленным дисковым хранилищем.

### Как это работает

* Каждая таблица и индекс в PostgreSQL хранятся в **страницах** размером 8 КБ.
* Когда запросу нужны данные, PostgreSQL сначала ищет нужную страницу **в буферном кеше**.
* Если страницы нет в кеше, сервер читает её с диска и помещает в кеш.
* После этого страница может многократно использоваться без обращения к операционной системе.
* Если страница была изменена, она помечается как **«грязная» (dirty)** — это значит, что её содержимое в памяти отличается от данных на диске.

### Почему кеш ускоряет работу

Доступ к оперативной памяти на порядки быстрее, чем к диску.
Чем больше данных помещается в кеш, тем реже приходится обращаться к диску.
Таким образом, даже простое чтение таблицы после первого выполнения запроса выполняется заметно быстрее — потому что данные уже находятся в памяти.

---

## 3. Вытеснение страниц (алгоритм LRU)

Размер кеша ограничен — он не может вместить всю базу данных.
Когда кеш заполняется, PostgreSQL должен **освободить место** под новые страницы.
Для этого используется **алгоритм вытеснения LRU (Least Recently Used)** — «вытеснение наименее недавно использованных» страниц.

Принцип работы:

1. Находит страницу, к которой давно не обращались.
2. Если страница грязная — записывает её на диск.
3. На освободившееся место помещает новую страницу.

Такой подход позволяет удерживать в памяти только «горячие» данные — те, которые используются чаще всего.

---

## 4. Журнал предзаписи (WAL)

### Проблема, которую решает WAL

Буферный кеш повышает производительность, но снижает надёжность.
Если произойдёт сбой (например, отключение питания), содержимое памяти, включая кеш, будет потеряно.
Чтобы не потерять изменения, PostgreSQL использует **журнал предзаписи (Write-Ahead Log, WAL)**.

### Принцип работы

Перед тем как изменённая страница будет записана на диск, сервер **сначала записывает в журнал WAL** описание изменений, достаточное для их последующего восстановления.

> **Ключевое правило WAL:**
> «Журнал всегда записывается на диск раньше, чем изменённые данные.»

Это гарантирует, что после сбоя можно будет восстановить все зафиксированные транзакции.

Журнальные файлы хранятся в каталоге:

```
PGDATA/pg_wal
```

### Что защищает журнал

WAL фиксирует все изменения, происходящие в памяти:

* страницы таблиц и индексов;
* служебные данные о состоянии транзакций.

Не защищаются:

* **временные таблицы** (существуют только в рамках сеанса или транзакции);
* **нежурналируемые таблицы** (созданные с опцией `UNLOGGED` — работают быстрее, но не восстанавливаются после сбоя).

---

## 5. Структура и нумерация журнала

Журнал WAL — это **непрерывный поток записей**.
Каждая запись имеет уникальный номер — **LSN (Log Sequence Number)**, который указывает её положение в журнале.

LSN — 64-битное число, показывающее смещение записи относительно начала журнала.
Функция `pg_current_wal_lsn()` возвращает текущую позицию в WAL.

Физически журнал хранится в виде файлов размером по 16 МБ (по умолчанию).
При переполнении создаются новые файлы — журнал растёт по мере активности системы.

---

## 6. Контрольная точка (Checkpoint)

### Зачем нужна

Если сервер будет хранить весь журнал с момента запуска, его объём быстро станет огромным.
Чтобы ограничить размер WAL и ускорить восстановление после сбоев, PostgreSQL периодически выполняет **контрольную точку**.

### Что делает контрольная точка

1. Принудительно записывает на диск **все грязные страницы** из буферного кеша.
2. Сохраняет служебную информацию о состоянии системы.
3. Обозначает, что все изменения, сделанные до этой точки, уже физически на диске.

После контрольной точки старые журнальные файлы можно удалить, так как для восстановления теперь достаточно тех, что созданы **после** неё.

### Восстановление после сбоя

При запуске после сбоя PostgreSQL:

1. Находит последнюю завершённую контрольную точку;
2. Читает записи WAL, созданные после неё;
3. Применяет их, «проигрывая» изменения, которые не успели попасть на диск.

Таким образом, база данных возвращается в согласованное состояние.

---

## 7. Производительность и режимы записи

### Синхронный режим

В этом режиме при фиксации транзакции сервер **дожидается**, пока запись попадёт на диск.
Это гарантирует, что зафиксированные данные не будут потеряны, но снижает производительность.

Для надёжности используется системный вызов `fsync`, который заставляет операционную систему записать данные на энергонезависимый носитель.

### Асинхронный режим

В этом режиме записи выполняет фоновый процесс `walwriter`.
Он периодически записывает накопленные изменения на диск с небольшой задержкой.
Производительность выше, но при внезапном сбое возможна потеря последних транзакций (до нескольких миллисекунд).

На практике PostgreSQL использует **оба режима**:

* короткие транзакции фиксируются синхронно;
* длинные и фоновая активность — асинхронно.

---

## 8. Процессы, связанные с буферным кешем и WAL

PostgreSQL использует несколько фоновых процессов, обеспечивающих работу кеша и журнала.

| Процесс                          | Назначение                                                          |
| -------------------------------- | ------------------------------------------------------------------- |
| **walwriter**                    | Асинхронная запись журнала на диск                                  |
| **checkpointer**                 | Выполняет контрольные точки — записывает все грязные буферы         |
| **background writer (bgwriter)** | Записывает часть грязных буферов заранее, чтобы ускорить вытеснение |
| **backend-процессы**             | Обслуживают клиентские подключения и читают данные в буферный кеш   |

Благодаря работе этих процессов данные читаются и записываются максимально эффективно и безопасно.

---

## 9. Уровни детализации журнала (параметр `wal_level`)

PostgreSQL может формировать журнал с разной степенью подробности.
Это настраивается параметром `wal_level`.

| Уровень                    | Назначение                                                                                              |
| -------------------------- | ------------------------------------------------------------------------------------------------------- |
| **minimal**                | Минимальная запись — только для восстановления после сбоя                                               |
| **replica (по умолчанию)** | Добавляет информацию, необходимую для резервного копирования и физической репликации                    |
| **logical**                | Добавляет сведения, позволяющие восстанавливать изменения в логическом виде (для логической репликации) |

### Применение:

* `minimal` — подходит для тестов, где надёжность не критична;
* `replica` — используется на большинстве серверов;
* `logical` — нужен, когда требуется передавать изменения на другие системы в виде SQL-запросов.

---

## 10. Итоги

* **Буферный кеш** ускоряет работу PostgreSQL, уменьшая количество обращений к диску.
* **Журнал WAL** обеспечивает надёжность — даже при сбое можно восстановить все зафиксированные изменения.
* **Контрольные точки** ограничивают размер журнала и ускоряют восстановление.
* **Фоновые процессы** (checkpointer, bgwriter, walwriter) автоматизируют запись и поддерживают баланс между скоростью и надёжностью.
* **Параметр `wal_level`** определяет, сколько информации записывается в журнал и какие возможности доступны (восстановление, резервное копирование, репликация).
