# Управление доступом в PostgreSQL

## 1. Общая структура системы прав

PostgreSQL использует чёткую модель управления доступом, включающую:

* **Роли (roles)** — субъекты доступа, которым принадлежат объекты и которым можно назначать привилегии;
* **Привилегии (privileges)** — разрешения на выполнение определённых действий с объектами;
* **Аутентификацию** — подтверждение личности при подключении к серверу;
* **Авторизацию** — проверку прав роли на выполнение действий после подключения.

Эта система позволяет реализовать как полностью открытые настройки (все пользователи могут всё), так и строгое разграничение доступа на уровне отдельных таблиц и даже столбцов.

---

## 2. Роли и их атрибуты

### Что такое роль

Роль — это сущность, которая может:

1. Представлять пользователя (если у неё есть атрибут `LOGIN`);
2. Объединять другие роли (групповая роль, без входа в систему).

Роли **не связаны напрямую** с пользователями операционной системы, хотя некоторые утилиты (например, `psql`) по умолчанию используют имя текущего пользователя ОС как имя роли.

### Начальная роль

При инициализации кластера создаётся **суперпользователь** — обычно `postgres`. Он имеет полный доступ к системе и может создавать новые роли.

### Основные атрибуты ролей

| Атрибут                 | Описание                                                      |
| ----------------------- | ------------------------------------------------------------- |
| `LOGIN` / `NOLOGIN`     | Разрешает или запрещает подключение к серверу.                |
| `SUPERUSER`             | Полные права на все объекты. Проверки доступа не выполняются. |
| `CREATEDB`              | Разрешает создавать базы данных.                              |
| `CREATEROLE`            | Разрешает создавать и изменять другие роли.                   |
| `INHERIT` / `NOINHERIT` | Определяет, наследует ли роль права включённых в неё ролей.   |
| `REPLICATION`           | Разрешает использовать роль для репликации.                   |
| `BYPASSRLS`             | Игнорирует политику безопасности строк (RLS).                 |

---

## 3. Подключение к серверу

Настройки доступа к серверу задаются в файле `pg_hba.conf`
(HBA — *Host-Based Authentication*).

### Алгоритм проверки подключения

1. PostgreSQL читает `pg_hba.conf` сверху вниз.
2. Находит первую строку, подходящую под параметры подключения:

   * тип (`local` — через Unix-сокет, `host` — по TCP/IP),
   * имя базы,
   * имя пользователя,
   * IP-адрес клиента.
3. Применяет указанный метод аутентификации.
4. Если проверка успешна — подключение разрешено; иначе — отклонено.

Если ни одна строка не подходит, соединение будет **запрещено**.

Пример типичной конфигурации:

```
# TYPE  DATABASE  USER      ADDRESS         METHOD
local   all       postgres                  peer
local   all       all                       peer
host    all       all       127.0.0.1/32    scram-sha-256
host    all       all       ::1/128         scram-sha-256
```

---

## 4. Методы аутентификации

| Метод           | Описание                                                            |
| --------------- | ------------------------------------------------------------------- |
| `trust`         | Разрешает подключение без проверки. Используется только для тестов. |
| `reject`        | Всегда запрещает подключение.                                       |
| `scram-sha-256` | Современный безопасный метод проверки пароля.                       |
| `md5`           | Устаревший метод проверки пароля (оставлен для совместимости).      |
| `peer`          | Сравнивает имя пользователя ОС и роли PostgreSQL.                   |

Метод выбирается в последнем поле строки `pg_hba.conf`.

---

## 5. Парольная аутентификация

Если метод требует пароль (`scram-sha-256` или `md5`):

* У роли **должен быть установлен пароль**, иначе подключение будет отклонено.
* Хеш пароля хранится в системном каталоге `pg_authid`.
* Ввод пароля можно автоматизировать:

  * через переменную окружения `PGPASSWORD`;
  * через файл `~/.pgpass`, содержащий строки:

    ```
    hostname:port:database:username:password
    ```

    Файл должен иметь права доступа `600`.

---

## 6. Привилегии (права доступа)

Привилегии определяют, **какие действия** роль может выполнять над объектами базы данных.
Связь между ролями (субъектами) и объектами хранится в системных каталогах.

### Основные типы привилегий

#### Таблицы и представления

| Привилегия   | Действие                                 |
| ------------ | ---------------------------------------- |
| `SELECT`     | Чтение данных.                           |
| `INSERT`     | Добавление строк.                        |
| `UPDATE`     | Изменение строк.                         |
| `DELETE`     | Удаление строк.                          |
| `TRUNCATE`   | Полная очистка таблицы.                  |
| `REFERENCES` | Использование таблицы во внешних ключах. |
| `TRIGGER`    | Создание триггеров.                      |

Некоторые из них (например, `SELECT` и `UPDATE`) можно задавать для отдельных столбцов.

#### Последовательности

* `SELECT` — чтение текущего значения (`currval`);
* `UPDATE` — изменение (`nextval`, `setval`);
* `USAGE` — общее разрешение на использование последовательности.

#### Схемы

* `USAGE` — разрешает обращение к объектам схемы;
* `CREATE` — разрешает создавать объекты в схеме.

#### Базы данных и табличные пространства

* `CONNECT` — разрешает подключение к базе;
* `CREATE` — создание схем или объектов;
* `TEMPORARY` — создание временных таблиц;
* для табличных пространств — `CREATE` (создание объектов внутри).

---

## 7. Категории ролей

1. **Суперпользователи (`SUPERUSER`)** — имеют полный доступ, проверки не выполняются.
2. **Владельцы объектов** — роли, создавшие объект. Они автоматически получают все права на него.
3. **Обычные роли** — могут выполнять действия только в рамках выданных привилегий.

Для проверки прав существует набор функций `has_*_privilege`, например:

```sql
SELECT has_table_privilege('alice', 'orders', 'INSERT');
```

---

## 8. Управление привилегиями

### Выдача прав:

```sql
GRANT привилегия [, ...] ON объект TO роль;
```

### Отзыв прав:

```sql
REVOKE привилегия [, ...] ON объект FROM роль;
```

Выдавать и отзывать права может:

* владелец объекта,
* суперпользователь.

Пример:

```sql
GRANT SELECT, UPDATE ON TABLE sales TO bob;
REVOKE UPDATE ON TABLE sales FROM bob;
```

---

## 9. Групповые роли и наследование

PostgreSQL не имеет отдельного типа «группа».
Роль может **включать** другие роли:

```sql
GRANT managers TO alice;
```

Теперь `alice` наследует привилегии роли `managers`.

### Наследование и переключение

* Если роль имеет атрибут `INHERIT` (по умолчанию), она автоматически использует привилегии включённой роли.
* Если `NOINHERIT`, то нужно явно переключиться:

  ```sql
  SET ROLE managers;
  ```

Существуют роли без `LOGIN`, предназначенные только для группировки прав.

---

## 10. Псевдороль `public`

Роль `public` **включает всех пользователей**, даже будущих.
Привилегии, выданные `public`, автоматически действуют для всех ролей.

По умолчанию `public` имеет:

* право подключения (`CONNECT`) ко всем базам;
* доступ к системным каталогам;
* выполнение всех функций и процедур (`EXECUTE`).

Это удобно для начала работы, но может создавать риски безопасности.
Если требуется строгая изоляция, эти права следует отозвать.

---

## 11. Предопределённые роли

PostgreSQL содержит ряд встроенных ролей с ограниченными административными правами.
Они позволяют делегировать задачи без назначения суперпользователя.

| Роль                         | Назначение                        |
| ---------------------------- | --------------------------------- |
| `pg_read_all_settings`       | Чтение всех параметров сервера.   |
| `pg_read_all_stats`          | Доступ к статистике.              |
| `pg_stat_scan_tables`        | Просмотр статистики и блокировок. |
| `pg_read_all_data`           | Чтение всех данных.               |
| `pg_write_all_data`          | Изменение всех данных.            |
| `pg_read_server_files`       | Чтение файлов на сервере.         |
| `pg_write_server_files`      | Запись файлов на сервере.         |
| `pg_execute_server_programs` | Запуск программ на сервере.       |

Полный список можно увидеть командой:

```
\duS
```

---

## 12. Привилегии по умолчанию

Каждый новый объект получает **набор начальных привилегий**.
Обычно — `EXECUTE` для `public` (для функций) и `USAGE`/`SELECT` для базовых системных объектов.

Чтобы изменить поведение, используется механизм **привилегий по умолчанию**:

```sql
ALTER DEFAULT PRIVILEGES
FOR ROLE alice
REVOKE EXECUTE ON ROUTINES FROM public;

ALTER DEFAULT PRIVILEGES
FOR ROLE alice
GRANT EXECUTE ON ROUTINES TO bob;
```

Эти настройки будут применяться ко **всем будущим объектам**, создаваемым указанной ролью.

---

## 13. Подпрограммы (функции и процедуры)

Для функций и процедур существует единственная привилегия — `EXECUTE`.

### Безопасность выполнения

| Ключевое слово     | Поведение                                        |
| ------------------ | ------------------------------------------------ |
| `SECURITY INVOKER` | Выполнение с правами вызывающего (по умолчанию). |
| `SECURITY DEFINER` | Выполнение с правами владельца функции.          |

Механизм `SECURITY DEFINER` позволяет создавать функции, выполняющие операции, недоступные обычным пользователям, но контролируемо.

---

## 14. Основные выводы

* Система ролей PostgreSQL универсальна: роль может быть и пользователем, и группой.
* Аутентификация управляется через `pg_hba.conf`, а авторизация — через привилегии.
* Суперпользователи имеют неограниченные права; владельцы управляют своими объектами.
* Групповые роли и предопределённые роли позволяют гибко делегировать права.
* Механизм **привилегий по умолчанию** помогает контролировать доступ к новым объектам.
* Безопасность функций регулируется через `SECURITY DEFINER` и `SECURITY INVOKER`.
